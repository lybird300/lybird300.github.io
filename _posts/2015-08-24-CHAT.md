---
layout: post
title: "CHAT"
date: 2015-08-24
---
Today I'm starting this post to record my thoughts while looking into Kirk's self-written software -- CHAT. Although I don't know (a) how often I will update, (b) how useful the content will be, or (c) how long it will take to complete the post, it is pretty exiting that after almost 5 months I'm finally here! ^_^

During the past 6+ years Kirk has been working on CHAT alone in his spare time. Now Charles and me are helping him publicize this software. To start with let me give you a brief introduction of CHAT. CHAT stands for Convergent Haplotype Association Tagging. It is a computer program that we are developing to detect rare moderate penetrant mutations from GWA data sets. <b>The core of this method is a graph-theory based algorithm that systematically searches for subsets of individuals that share long range haplotypes</b>. The underlying assumption is that a small (but significant) subset of unrelated individuals have the same disease because they have inherited a moderate penetrant mutation from a distant common ancestor. Since the algorithm is computationally intensive (an NP-complete problem), we have been cooperating with the Renaissance Computational Institute (RENCI) and using their high-performance computing clusters. How powerful these machines are? "Consider the (computing and storage) resources are limitless." said Erik Scott, a Senior Research Software Developer at RENCI. 

Previous work showed the success of CHAT in constructed and simulated data sets as well as real data sets. The program has been applied in several independent projects to search for the genetic basis (i.e., causal mutations) of and treatment targets for diseases such as Parkinson's disease, stroke, alcoholism, multiple sclerosis, lymphoid cancer, and lung cancer and smoking. These studies found that CHAT is more likely to be successful with phenotypes that have lower population prevalence. The next step is to test CHAT using additional real data sets as they become available. Our goal is to help establish the baseline rate for detecting clusters of individuals with long shared haplotypes and to establish collaboration to resequence several genes for a few subjects. Fancy, right? 

When I first looked into the code of CHAT, my impression is that Kirk put into a lot of efforts to make this software fault tolerant when working with clusters. CHAT tries to break up the jobs to use the number of CPUs that are expected. If a job fails it will be restarted and is often broken up into smaller jobs. CHAT keeps track of finished jobs and tries to resume remaining or failed ones. Most output files have internal line count information, so that a corrupted file can be automatically detected. Files are usually checked once for completeness but also frequently checked for whether they are where they are supposed to be. The above settings are accomplished through a properties file and can be changed in some in the longest step (i.e., phasing). Any step can be reinitialized (organized as multiple beans in the properties file), but then all subsequent steps then need to reinitialized. The intermediate data is stored in a derby database. 

<h2>Play with CHAT</h2>
In the package there is a test example folder called TestDebug that can be copied to a workspace as a test use case. This folder contains a genotype file that has just the data for a region on chromosome that contains the lrrk2 locus. 48 of the subjects in the pedigree file have a LRRK2 mutation that causes parkinsonsin's disease. The file lrrk_samples_save list the subjects. Not all of them are included in the analysis as CHAT excludes closely related individuals. Before running the test example, make sure you have done the following:
<ul>
<li>From root (chat) import  (by right click and choose import from the drop-down menu) an existing project into workspace for each of the sub directories. (i.e., chat-common, chat-prep, chat-core etc). The classes built in these directories are what that are actually executed.</li>
<li>Change the working directory to wherever you put the <i>TestDebug</i> folder (Debug configuration --> Arguments tab --> Working directory (click on "Other" and specify the path of the folder)</li>
</ul>
The "TestDebug" folder contains the minimal input files CHAT needed (specified at the beginning of the "CHAT.properties" file). If you prefer your own test data, please also create and format these files as instructed below. (Note: there is no need to name these files by specific extensions, e.g., .lgen, .map, or .sample; you can simply use ".txt" or nothing)
<ul>
<li>A raw genotype file (also referred to as the lgen file) with tab or comma delimited columns:<br/>
     <i>chromID,pos,rs,subjectID,Genotype[,CONFIDENCE]</i><br/>
A lgen file corresponds to a single chromosome and each line in the file describes a subject's genotype of a particular marker SNP on that chromosome. The first five columns (required) provide detailed information on a marker: its located chromosome, physical position, <a href="http://www.ncbi.nlm.nih.gov/books/NBK44417/">rs number</a>, ID of the subject (individual), and genotype. The genotype data should be in single char format (e.g. 0,1,2 for AA, AG, GG) or <a href="http://www.bioinformatics.org/sms/iupac.html ">the IUPAC format</a> (e.g., A,R,G for AA, AG, GG). The last column (optional) gives a float-type confidence value that can be used to filter the data. This file can be gzipped (end with .gz) to save space. </li>
<li>A LDU map file: tab or comma delimited columns:<br/>
     <i>chromID,pos,rs,ldumap (-999999 for unknown place holder),in use bit</li>
The first three columns have the same meanings as in the lgen file. The fourth column (ldumap) indicates a particular marker's LDU (linkage disequilibrium unit) map position. The last column indicates whether or not this record will be used in later analysis: 0 means no use and 1 means use. 
<li>A sample file: tab or comma delimited SubjectID, DX (disease affection; {0,1,2}; 2 for affect,1 for unaffected, 0 for unknown}),Sex{2 female,1 male, 0 unknown},in use bit {0,1}</li> 
</ul>
<h2>Major modules/steps of CHAT</h2>
The first step is to convert input files into CHAT accepted format. This step is controlled by the CHAT_prep.xml file in the same folder and accomplished by multiple beans sequentially. Users can skip a bean by commenting out the corresponding ref bean line in the threadList of the XML file using <!-- statement -->.

The first three beans check the format of input files. "CheckLgenStructureRunnable" conducts sanity check on the lgen file. If there are any problematic genotype records (i.e., lines) in the file, the process will be terminated so that users can review detected problems (recorded in a "problemGenotypes.txt" file in the same folder). All "filtered" (i.e., non-problematic) genotype records are outputted into a file named by adding a prefix "Filtered" to the old lgen file. If the user is willing to ignore (instead of trying to modify) all identified problem lines, he or she can set the "projectRawLongDataFileName" field in CHAT.properties (the filed indicates the lgen file to be used)  to the file that contains all filtered genotype records (i.e., the one whose name starts with "Filtered"). Notably, the bean creates three more files: (a) "GenotypeContainsChrom.txt" stores involved chromosomes (ordered by chromID), each per line. (b) "GenotypeContainsSamples.txt" stores involved subjects (ordered by subjectID), each per line with the format:<br/>
<i>subjectID,place holder for unknown disease affection state (0),place holder for unknown sex (0),1</i><br/>
(c) "GenotypeContainsSNPs.txt" stores involved marker SNPs (ordered by marker position), each per line with the format:<br/>
<i>chromID,pos,rsnumber,place holder for unknown LDU map (a genetic map) position (-77777.0),1</i><br/>

The second bean "CheckMapStructureRunnable" conducts sanity check on the LDU map file. If there are any problematic genotype records (i.e., lines) in the file, the process will be terminated so that users can review detected problems (recorded in a "ProblemMapRecords.txt" file in the same folder). All "filtered" (i.e., non-problematic) genotype records are outputted into a file named by adding a prefix "Filtered" to the old lgen file. If the user is willing to ignore (instead of trying to modify) all identified problem lines, he or she can set the "projectRawLongDataFileName" field in CHAT.properties (the filed indicates the lgen file to be used)  to the file that contains all filtered genotype records (i.e., the one whose name starts with "Filtered"). Notably, the bean creates three more files: (a) "MapContainsChrom.txt" stores involved chromosomes (ordered by chromID), each per line. (b) "MapContainsSamples.txt" stores involved subjects (ordered by subjectID), each per line with the format:<br/>
<i>subjectID,place holder for unknown disease affection state (0),place holder for unknown sex (0),1</i><br/>
(c) "MapContainsSNPs.txt" stores involved marker SNPs (ordered by marker position), each per line with the format:<br/>
<i>chromID,pos,rsnumber,place holder for unknown LDU map position (-77777.0),1</i><br/>
